
{{- /* Generate the search index. */ -}}
{{ $exclude := .exclude }}
{{ $lang := .lang }}
{{- $rowHeight := .rowHeight | default .Site.Params.gallery.rowHeight | default 300 -}}

{{- $index := slice -}}
{{- $pages := site.RegularPages -}}
{{- /* Add the index page of multi-page content separately since it's not in RegularPages above. */ -}}
{{- $pages := $pages | union (where (where site.Pages "Kind" "section") "Type" "book") -}}
{{- /* Add author pages to index so their bios can be searched. Hide empty `/authors/` node. */ -}}
{{- $pages := $pages | union (where (where site.Pages "Section" "authors") "Params.superuser" "!=" nil) -}}

{{- range $pages -}}
  {{- /* Do not index drafts or private pages. */ -}}
  {{- if and (not .Draft) (not .Params.private) (ne .Params.searchable false) (not (in .Permalink "hidden")) (not (in .Permalink $exclude )) -}}

    {{- /* Generate page description. */ -}}
    {{- $desc := "" -}}
    {{- if .Params.summary -}}
      {{- $desc = .Params.summary -}}
    {{- else if .Params.abstract -}}
      {{- $desc = .Params.abstract -}}
    {{- else -}}
      {{- $desc = .Summary -}}
    {{- end -}}

    {{- $authors := .Params.authors -}}
    {{- $title := .Title}}
    {{- $rel_permalink := .RelPermalink -}}
    {{- $permalink := .Permalink -}}

    {{/* Correct the title and URL for author profile pages. */}}
    {{- if eq .Section "authors" -}}
      {{- $username := path.Base .File.Dir -}}
      {{- with site.GetPage (printf "/authors/%s" $username) -}}
        {{- $permalink = .Permalink -}}
        {{- $rel_permalink = .RelPermalink -}}
      {{- end -}}
    {{- else -}}
      {{/* Include a user's display name rather than username where possible. */}}
      {{- if .Params.authors -}}
        {{- $authorLen := len .Params.authors -}}
        {{- if gt $authorLen 0 -}}
          {{- $authors = slice -}}
            {{- range $k, $v := .Params.authors -}}
              {{- $person_page_path := (printf "/authors/%s" (urlize $v)) -}}
              {{- $person_page := site.GetPage $person_page_path -}}
              {{- if and $person_page $person_page.File -}}
                {{- $authors = $authors | append $person_page.Title -}}
              {{- else -}}
                {{- $authors = $authors | append ($v | plainify) -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
    {{- end -}}
    {{ $thumbnail := slice }}
    {{- if (and .Params.gallery .Params.cover) -}}
      {{- $thumbnail = path.Join "/" .Params.gallery .Params.cover -}}
    {{- end -}}

    {{- /* Add page to index. */ -}}
    {{/* Exclude virtual pages which aren't backed by a file */}}
    {{- if .File -}}
      {{- $index = $index | append (dict "objectID" (print $lang "-" .File.UniqueID) "thumbnail" $thumbnail "date" .Date.UTC.Unix "publishdate" .PublishDate "lastmod" .Lastmod.UTC.Unix "expirydate" .ExpiryDate.UTC.Unix "lang" .Lang "permalink" $permalink "relpermalink" $rel_permalink "title" $title "summary" (plainify $desc | htmlUnescape) "content" (.Plain | htmlUnescape | truncate 5000) "authors" $authors "kind" .Kind "type" .Type "section" .Section "tags" .Params.Tags "categories" .Params.Categories) -}}

      {{- if .Params.gallery -}}
        {{- $files := .Params.files | default "*.jpg" -}}
        {{- $galleryPath := path.Join ( print "*" .Params.gallery) $files -}}
        {{- $metadataPath := path.Join .Params.gallery ".metadata" -}}
        {{- $images := resources.Match $galleryPath -}}
        {{- range $image := $images -}}
          {{- $metadataFileName := path.Join $metadataPath (printf "%s.json" (path.Base $image.Name) ) -}}
          {{- $metadata := resources.Get $metadataFileName -}}
          {{- if $metadata -}}
				    {{- $metadata = $metadata.Content | unmarshal -}}
            {{- with $metadata -}}
              {{- if or .Title .Subject .Tags -}}
                {{- $thumbnailWidth := (int (div (mul (mul $image.Width 1.0) $rowHeight) $image.Height)) -}}
                {{- $thumbnail := ($image.Fit (printf "%dx%d webp" $thumbnailWidth $rowHeight)) -}}
                {{- $record := (dict
                  "objectID" (md5  $image.RelPermalink)
                  "size" $thumbnailWidth
                  "relpermalink" (printf "%s#%s" $rel_permalink (partial "functions/url_encode" $image.Name))
                  "album" $title
                  "title" (.Title | default "")
                  "summary" (.Subject |default "")
                  "thumbnail" (partial "functions/url_encode" $thumbnail.RelPermalink)
                  "date" (partial "functions/parse_date" (index . "Date taken") ).Unix
                  "section" .Kind
                  "tags" (split .Tags "; ")
                  "rating" .Rating
                )
                -}}
                {{- $index = $index | append ( $record ) -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}

          {{/*

          "date" (.["Date taken"])
          // {{ with $image.Exif }}
          //   {{- $record = merge $record (dict
          //     "permalink" (printf "%s#%s" $permalink $image.Name)
          //     "relpermalink" (printf "%s#%s" $rel_permalink $image.Name)
          //     "title" $image.Title
          //     "summary" (cond ( isset .Tags "ImageDescription") .Tags.ImageDescription "")
          //     "date" .Tags.DateTimeOriginal
          //     "section" "image"
          //   )
          //   -}}
				  {{ end }}
          {{- $index = $index | append ( $record ) -}}

          */}}

        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $index | jsonify -}}
