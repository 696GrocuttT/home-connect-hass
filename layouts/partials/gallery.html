{{- $currentPage := .currentPage}}
{{- $gallery := .gallery -}}
{{- $files := .files | default "*.jpg" -}}
{{- $sort := .sort | default "asc" -}}
{{- $rowHeight := .rowHeight | default .rowheight | default .Site.Params.gallery.rowHeight | default 300 -}}
{{- $margins := .margins | default 2 -}}
{{- $imageResizeOptions := .imageResizeOptions | default .imageresizeoptions | default (.Site.Params.gallery.imageResizeOptions | default "1920x1080 webp") -}}
{{- $loadJQuery := .loadJQuery | default .loadjquery | default true -}}
{{- $showExif := .showExif | default .showexif | default false -}}
{{- $captions := .captions | default true -}}
{{- $justifiedGalleryParameters := .justifiedGalleryParameters | default .justifiedgalleryparameters -}}
{{- $previewType := .previewType | default .previewtype | default "blur"}}
{{- $embedPreview := .embedPreview |default .embedpreview | default true}}
{{- $lastRowJustification := .lastRowJustification | default .lastrowjustification | default "nojustify" -}}
{{- $galleryId := .galleryId | default (printf "gallery-%v" (delimit (shuffle (seq 1 9)) "")) -}}
{{- $filterOptions := "[]" -}}

{{ $rtl := eq .Site.Language.LanguageDirection "rtl" }}
{{ $searchPath := path.Join (print "*" $gallery) $files}}
{{- $images := resources.Match $searchPath -}}

{{- if ne $sort "random" -}}
	{{- $images = sort $images "Name" $sort -}}
{{- end -}}

{{/*  {{- $images := resources.Match "*gallery/Travel/Iceland/*.jpg" -}}
{{ range $image := $images}}
	{{ $image.RelPermalink}}
	{{ $new := $image.Fit "100x100"}}
	{{ $new.RelPermalink }}<br>
{{ end }}  */}}

<!-- hugos image processing saves images at resources/_gen/images, if the property resourceDir
	 is changed in hugos config.toml file the images are save <resourceDir>/_gen/images.
	 Because it is not possible to access the value of resourceDir, users who change resourceDir also have to change
	[params] resourceDir. -->
	{{- $thumbnailResourceDir := printf "%s%s" (.Site.Params.resourceDir | default "resources") "/_gen/images/" -}}

<!-- Load jquery, jquery-lazy, swipebox and justified_gallery only once per page -->
{{- if not ($currentPage.Scratch.Get "galleryLoaded") -}}
  	{{- $currentPage.Scratch.Set "galleryLoaded" true -}}
	<!-- Use relURL to support hugo projects that run in a subdirectory (bug #18) -->

	{{- if $loadJQuery -}}
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
		<script>
			var jQuery_local = $;
		</script>
	{{- end -}}

	{{- if not (eq $previewType "none") -}}
		<script src="https://cdn.jsdelivr.net/npm/jquery-lazy@1.7.11/jquery.lazy.min.js"></script>
	{{- end -}}

	<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"/>
{{- end -}}

{{- if not ($currentPage.Scratch.Get "fancyboxLoaded") -}}
	{{/*  loading fb in gallery  */}}
	{{/*  {{- warnf (printf "loading fb in gallery %s" $currentPage.RelPermalink) -}}  */}}
	{{- $currentPage.Scratch.Set "fancyboxLoaded" true -}}
	<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0.29/dist/fancybox.umd.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css">
{{/*  {{- else -}}
	not loading in gallery
	{{- warnf (printf "skipping fb in gallery %s" .currentPage.RelPermalink) -}}  */}}
{{- end -}}
<style>
.fancybox__caption {
	text-align: {{ cond $rtl "right" "left"}};
	font-size: 1.2em;
}
.fancybox__caption .caption-summary {
	color: #c0c0c0;
	font-size: 0.9em;
}

</style>
<script>
Fancybox.Plugins.Toolbar.defaults.items.share = {
	type: "button",
	class: "fancybox__button--share",
	label: "Share",
	html: '<svg xmlns="http://www.w3.org/2000/svg" style="color:white;" width="24" height="24" viewBox="0 0 448 512"><path fill="white" d="M448 127.1C448 181 405 223.1 352 223.1C326.1 223.1 302.6 213.8 285.4 197.1L191.3 244.1C191.8 248 191.1 251.1 191.1 256C191.1 260 191.8 263.1 191.3 267.9L285.4 314.9C302.6 298.2 326.1 288 352 288C405 288 448 330.1 448 384C448 437 405 480 352 480C298.1 480 256 437 256 384C256 379.1 256.2 376 256.7 372.1L162.6 325.1C145.4 341.8 121.9 352 96 352C42.98 352 0 309 0 256C0 202.1 42.98 160 96 160C121.9 160 145.4 170.2 162.6 186.9L256.7 139.9C256.2 135.1 256 132 256 128C256 74.98 298.1 32 352 32C405 32 448 74.98 448 128L448 127.1zM95.1 287.1C113.7 287.1 127.1 273.7 127.1 255.1C127.1 238.3 113.7 223.1 95.1 223.1C78.33 223.1 63.1 238.3 63.1 255.1C63.1 273.7 78.33 287.1 95.1 287.1zM352 95.1C334.3 95.1 320 110.3 320 127.1C320 145.7 334.3 159.1 352 159.1C369.7 159.1 384 145.7 384 127.1C384 110.3 369.7 95.1 352 95.1zM352 416C369.7 416 384 401.7 384 384C384 366.3 369.7 352 352 352C334.3 352 320 366.3 320 384C320 401.7 334.3 416 352 416z"/></svg>',
	click: function (event) {
		event.preventDefault();
		toggleShareDialog(event);
	},
};

function getFancyboxOptions() {
	return {
		Image: {
			"fit": "contain",
		},
		Carousel: {
			Autoplay: {
				timeout: 1000,
			}
		},
		Toolbar: {
			display: [
				//{ id: "prev", position: "left" },
				{ id: "counter", position: "left" },
				//{ id: "next", position: "left" },
				"share",
				"zoom",
				"slideshow",
				"fullscreen",
				"download",
				"thumbs",
				"close",
			],
		},
		on: {
			//"*": (event, fancybox, slide) => {
			//  console.log(`event: ${event}`);
			//},
			ready: (fancybox, slide) => {
				fancybox.plugins.Thumbs.toggle();
				if (typeof fancybox.Carousel.plugins.Autoplay != 'undefined') {
					fancybox.Carousel.plugins.Autoplay.stop();
				}
				if (typeof _allCarousels != 'undefined') {
					_allCarousels.forEach( carousel => {
						carousel.plugins.Autoplay.stop();
					});
				}
			},
			"Carousel.createSlide": (fancybox, carousel, slide) => {
			//console.log(slide.$el);
			//fancybox.getSlide().Panzoom.zoomIn();
			},

			closing: (fancybox, slide) => {
				if (typeof _allCarousels != 'undefined') {
					_allCarousels.forEach( carousel => {
						carousel.plugins.Autoplay.start();
					});
				}
			},

		},
	}
}

Fancybox.bind('[data-fancybox="{{$galleryId}}"]', getFancyboxOptions() );
</script>
<div id="{{- $galleryId -}}" class="justified-gallery fullscreen">
	{{ range $original := $images}}
		{{- if eq $original.ResourceType "image" -}}
			{{/* Get metadata from sidecar file, if present. Else an empty dictionary is used. */}}
			{{- $metadataFileName := path.Join $gallery ".metadata" (printf "%s.json" (path.Base $original.Name) ) -}}
			{{- $metadata := resources.Get $metadataFileName -}}
			{{- if $metadata -}}
				{{- $metadata = $metadata | unmarshal -}}
			{{- else -}}
				{{- $metadata = dict -}}
			{{- end -}}

			{{/* If the image has exif informations, those are merged together with the metadata from the file */}}
			{{- if in "jpg jpeg tiff" $original.MediaType.SubType -}}
				{{- with $original.Exif -}}
					{{- $metadata = merge .Tags $metadata -}}
				{{- end -}}
			{{- end -}}

			{{/* Create thumbnail */}}
			{{- $thumbnailWidth := (int (div (mul (mul $original.Width 1.0) $rowHeight) $original.Height)) -}}
			{{- $thumbnail := ($original.Fit (printf "%dx%d webp" $thumbnailWidth $rowHeight)) -}}

			<div>
				{{- $full := "" -}}
				{{- if $imageResizeOptions -}}
					{{/* Downscale gallery image */}}
					{{- $full = $original.Fit $imageResizeOptions -}}
				{{- else -}}
					{{- $full = $original -}}
				{{- end -}}
				<a href="{{- partial "functions/url_encode" $full.RelPermalink -}}" data-fancybox="{{$galleryId}}"
					class="galleryImg"
					data-download-src="{{ partial "functions/url_encode" $original.RelPermalink }}"
					data-thumb="{{ partial "functions/url_encode" $thumbnail.RelPermalink }}"
					data-slug="{{- path.BaseName $original.Name -}}" id="{{- path.BaseName $original.Name -}}"
					{{/*  data-meta="{{- $metadata -}}" */}}
					{{- if $captions -}}
						{{- with $metadata -}}
							{{ $date := (index . "Date modified") }}
							{{ $date = cond (ne $date nil) (printf " (%s)" (substr $date 0 -6)) ("") }}
							{{ $title := print (cond ( ne .Title nil) .Title "") $date }}
							alt="{{- .Title -}}"
							data-caption="<span class='caption-title'>{{$title}}</span>{{ cond (ne .Subject nil) (print "<br/><span class='caption-summary'>" .Subject "</span>") "" }}"

							{{- if $showExif }}
								data-description="{{- .Model -}} + {{- .LensModel -}}<br/>{{- .FocalLength -}}mm f/{{- .FNumber -}} {{- .ExposureTime -}}sec ISO {{- .ISOSpeedRatings -}}"
							{{- end -}}

							{{- if not (eq $filterOptions "[]")  -}}
								{{/* only include fields that are currently supported by the filter mechanism (in JS at the end of the file) */}}
								data-meta="{{- (dict "Tags" $metadata.Tags "Rating" $metadata.Rating "ColorLabels" $metadata.ColorLabels "ImageDescription" $metadata.ImageDescription) | jsonify -}}"
							{{- end -}}
						{{- end -}}
					{{- end -}}
					>
					<img
						width="{{- $thumbnail.Width -}}" height="{{- $thumbnail.Height -}}"
						{{- if (eq $previewType "blur") -}}
							{{- $preview_b := ($thumbnail.Fit ("24x24 q70 NearestNeighbor webp")) -}}
							style="filter: blur(25px);"
							{{- if $embedPreview -}}
								src="data:image/jpeg;base64,{{- $preview_b.Content | base64Encode -}}"
							{{- else -}}
								src="{{- $preview_b.RelPermalink -}}"
							{{- end -}}
							class="lazy"
							data-src="{{- partial "functions/url_encode" $thumbnail.RelPermalink -}}"
						{{- else if (eq $previewType "color") -}}
							{{- $preview_1p := ($thumbnail.Resize ("1x1 NearestNeighbor webp")) -}}
							{{- if $embedPreview -}}
								src="data:image/png;base64,{{- $preview_1p.Content | base64Encode -}}"
							{{- else -}}
								src="{{- $preview_1p.RelPermalink -}}"
							{{- end -}}
							class="lazy"
							data-src="{{- partial "functions/url_encode" $thumbnail.RelPermalink -}}"
						{{- else -}}
							src="{{- partial "functions/url_encode" $thumbnail.RelPermalink -}}"
						{{- end -}}
						{{- if $captions -}}
							{{- with $metadata -}}
								{{- if .Title -}}
									alt="{{- .Title -}}"
								{{- end -}}
							{{- end -}}
						{{- end -}}
					>
				</a>
			</div>
		{{- end -}}
	{{- end -}}
</div>



<script>
	if (!jQuery_local) {
		alert("jquery is not loaded");
	}

	jQuery_local( document ).ready(() => {
		let $ = jQuery_local
		const gallery = jQuery_local("#{{- $galleryId -}}");

		// before the gallery initialization the listener has to be added
		// else we can get a race condition and the listener is never called
		gallery.on('jg.complete', () => {
			//
			{{ if or (eq $previewType "blur") (eq $previewType "color") }}
				// if there is already some low resolution image data loaded, then we will wait for loading´
				// the hi-res until the justified gallery has done the layout
				jQuery_local(() => {
					jQuery_local('.lazy').Lazy({
						visibleOnly: true,
						afterLoad: element => element.css({filter: "none", transition: "filter 1.0s ease-in-out"})
					});
				});
			{{ end }}

		});

		// initialize the justified gallery
		gallery.justifiedGallery({
			rowHeight : {{- $rowHeight -}},
			margins : {{- $margins -}},
			border : 0,
			waitThumbnailsLoad : false,
			lastRow : {{- $lastRowJustification -}},
			captions : {{- $captions -}},
			randomize: {{- eq $sort "random" -}}
			// if there is at least one filter option
		});
    });


// Start the fancybox with a selected image if it is specified in the url
//function startFancyboxFromUrl() {
//  if (!Fancybox.getInstance()) {
//    const { hash, slug, index } = Fancybox.Plugins.Hash.getParsedURL();
//	console.log("hash="+hash+"   slug="+slug + "  index=1"+index);
//    if (hash && slug) {
//	  //Fancybox.show();
//	  Fancybox.fromOpener('[data-fancybox="{{$galleryId}}"]', { slug: hash});
//    }
//  }
//}
//window.addEventListener("hashchange", startFancyboxFromUrl, false);
//startFancyboxFromUrl();

</script>

